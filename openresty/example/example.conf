
#lua.conf

server {
    listen  8080;

    server_name  _;

    location /lua {
        default_type 'text/html';
        #lua_code_cache off; #生产环境开启
        content_by_lua_file /usr/example/lua/test.lua;
    }

    location ~* \.do {
        set $a gateway;
        rewrite ^ /bar;
    }

    location /foo {
        set $a hello;
        rewrite ^ /bar;
    }

    location /bar {
        echo "a = {$a}";
    }

    location /test {
        echo "uri = $uri";
        echo "request_uri = $request_uri";
        set $orig_a $arg_a;
        set $args "a=5";
        echo "original a: $orig_a";
        echo "a: $arg_a";
    }

    location /lua_version {
        content_by_lua '
            if jit then
                ngx.say(jit.version)
            else
                ngx.say(_VSERSION)
            end
        ';
    }

    location ~ /lua_request/(\d+)/(\d+) {
        set $a $1;
        set $b $host;
        default_type "text/html";
        content_by_lua_file /usr/example/lua/test_request.lua;
        echo_after_body "ngx.var.b $b";
    }

    location /lua_response_1 {
        default_type "text/html";
        content_by_lua_file /usr/example/lua/test_response_1.lua;
    }

    location /lua_response_2 {
        default_type "text/html";
        content_by_lua_file /usr/example/lua/test_response_2.lua;
    }

    location /lua_other {
        default_type "text/html";
        content_by_lua_file /usr/example/lua/test_other.lua;
    }

    location /lua_shared_dict {
        default_type "text/html";
        content_by_lua_file /usr/example/lua/test_lua_shared_dict.lua;
    }

    location /lua_set_1 {
        default_type "text/html";
        set_by_lua_file $num /usr/example/lua/test_set_1.lua;
        echo $num;
    }

    location /lua_rewrite_1 {
        default_type "text/html";
        rewrite_by_lua_file /usr/example/lua/test_rewrite_1.lua;
        echo "no rewrite";
    }

    location /lua_rewrite_2 {
        default_type "text/html";
        rewrite_by_lua_file /usr/example/lua/test_rewrite_2.lua;
        echo "rewrite2 uri : $uri, a : $arg_a";
    }

    location /lua_access {
        default_type "text/html";
        rewrite_by_lua_file /usr/example/lua/test_access.lua;
        echo "access";
    }

    location /lua_module_1 {
        default_type "text/html";
        lua_code_cache on;
        content_by_lua_file /usr/example/lua/test_module_1.lua;
    }

    location /lua_redis_basic {
        default_type "text/html";
        lua_code_cache on;
        content_by_lua_file /usr/example/lua/test_redis_basic.lua;
    }

    location /lua_redis_pipeline {
        default_type "text/html";
        lua_code_cache on;
        content_by_lua_file /usr/example/lua/test_redis_pipeline.lua;
    }

    location /lua_redis_script {
        default_type "text/html";
        lua_code_cache on;
    }

    location /lua_mysql {
        default_type "text/html";
        lua_code_cache on;
        content_by_lua_file /usr/example/lua/test_mysql.lua;
    }

    location /upload {
        default_type "application/octet-stream";

        client_max_body_size 1024k;
        client_body_buffer_size 1024k;

        #lua_need_request_body on;

        #访问限制
        access_by_lua_file /usr/example/lua/fs/auth.lua;
        #上传操作
        content_by_lua_file /usr/example/lua/fs/upload.lua;
        #日志
        error_log  logs/upload_error.log  info;
        access_log logs/upload_access.log upload;
    }

#    location ~ /download/.*\.(gif|jpg|jpeg|png) {
#    location ~ /download/(.*) {
#        default_type application/octet-stream;
#        root /usr/example;
#        content_by_lua_file /usr/example/lua/download_file.lua;
#    }

    # 虚拟目录
    location /download/index {
        autoindex on; # 索引
        autoindex_exact_size off; # 显示文件大小
        autoindex_localtime on;  # 显示文件时间
        alias /usr/example/download; # 源目录
    }

    location /images {
        default_type "text/html";
        echo "/images/";
    }

    location /images/abc {
        default_type "text/html";
        echo "/images/abc";
    }

    location ~ /images/abc {
        default_type "text/html";
        echo "~ /images/abc";
    }

    location ~ /lua_cjson {
        default_type 'text/html';
        lua_code_cache on;
        content_by_lua_file /usr/example/lua/test_cjson.lua;
    }
}

server {
    listen    8081;

    location  /test {
        set $args "foo=1&bar=2";
        proxy_pass "http://127.0.0.1:8082/args";
    }
}

server {
    listen    8082;

    location  /args {
        echo "args: $args";
    }
}